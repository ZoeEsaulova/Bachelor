<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <!-- jQuery -->
    <script type="text/javascript" src="onlinefolio/layout/scripts/jquery.min.js"></script>
    <script type="text/javascript" src="onlinefolio/layout/scripts/jquery.slidepanel.setup.js"></script>

    <!--script type="text/javascript" src="javascripts/jquery.imgareaselect-0.9.10/scripts/jquery.min.js"></script-->
    <script type="text/javascript" src="javascripts/jquery.imgareaselect-0.9.10/scripts/jquery.imgareaselect.pack.js"></script>
    <link rel="stylesheet" type="text/css" href="javascripts/jquery.imgareaselect-0.9.10/css/imgareaselect-default.css" />
    <!--bootstrap-->
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <!--script type="text/javascript" src="bootstrap-3.3.5/docs/assets/js/ie-emulation-modes-warning.js"></script>
    <script type="text/javascript" href="bootstrap-3.3.5/dist/js/bootstrap.min.js"></script>
    <script type="text/javascript" href="bootstrap-3.3.5/dist/js/bootstrap.js"></script-->
    <link href="bootstrap-3.3.5/docs/examples/starter-template/starter-template.css" rel="stylesheet">
    <link href="bootstrap-3.3.5/dist/css/bootstrap.min.css" rel="stylesheet"> 
    <!-- Open Layers 3 -->
    <link rel="stylesheet" href="http://openlayers.org/en/v3.10.1/css/ol.css" type="text/css">
    <script src="http://openlayers.org/en/v3.11.2/build/ol-debug.js" type="text/javascript"></script>
    <!-- LayerSwitcher -->
    <link rel="stylesheet" href="ol3-layerswitcher-master/src/ol3-layerswitcher.css" />
    <link rel="stylesheet" href="ol3-layerswitcher-master/examples/layerswitcher.css" />
    <script src="ol3-layerswitcher-master/src/ol3-layerswitcher.js"></script>
    <script src="ol3-layerswitcher-master/examples/layerswitcher.js"></script>
    <script src="ol3-layerswitcher-master/examples/addlayer.js"></script>

    <title>Geotagged images</title>
    <style type="text/css">
      img {
        width: 100%;
        margin-top: 50px
      }    
      #map {
        margin: 0;
        margin-top: 50px;
        z-index: 0;
      } 
      .col-lg-6 {
        margin-left: 0;
        margin-right: 0;
        padding-left: 0;
        padding-right: 0;
      }
      #hidden1 {
        right: 40px;
      }
      .form-control {
        white-space: nowrap;
      }
      .input {
        width: 70px;
        height: 35px; 
        white-space: nowrap;
        border-radius: 5px;
        position: relative;
        top: 3px;
      }
      button {
        margin: 2px;
        position: relative;
        top: 50%;
      }
      #get {
        margin-right: 1px;

      }
      #getObjects {

      }
      .well {
          background: rgba(255,0,0,0.2);
          margin: 0px;
          padding: 10px;
      }
      #next {
        position: relative;
        left: 85%;
        margin-top: 5px
      }
      #link {
        color: blue;
        text-decoration: underline;
      }
      .container {
        margin: 0px;
      }
      .form-group {
        text-align: center;;
      }
      .inputClass {
        margin-top: 0px;
        margin-left: 0px;
      }
    </style>
  </head>

  <% if (showBuilding) { %>
       <body onload="showBuildings('<%= buildingCoords %>','<%= properties %>', '<%= arrow %>', '0')">
  <% } else { %>
       <body onload="showMarker(<%= properties %>, 'arrow', '0')">
  <% }%>
      <!-- Modal -->
      <div class="modal fade" id="modal" role="dialog">
        <div class="modal-dialog modal-lg">
        
          <!-- Modal content-->
          <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal">&times;</button>
              <h4 class="modal-title">Please evaluate the task you have just finished</h4>
            </div>
            <div class="modal-body">
        <form class="form-horizontal" style="margin: 5px;" method="post" action="/survey/next/<%= entryId %>">
          <fieldset>
            <div class="form-group">
              <label for="inputEmail" class="col-lg-4 control-label"></label>
              <div class="col-lg-1">      
                  <label>
                    Strongly disagree
                  </label>             
              </div>
              <div class="col-lg-1">      
                  <label>
                    Disagree
                  </label>             
              </div>
              <div class="col-lg-1">      
                  <label>
                    Neutral
                  </label>             
              </div>
              <div class="col-lg-1">      
                  <label>
                    Agree
                  </label>             
              </div>
              <div class="col-lg-1">      
                  <label>
                    Strongly agree
                  </label>             
              </div>
            </div>
            <!--legend><h3 style="padding: 15px; color: rgba(28,195,200,1);">Please fill in the form first</h3></legend-->
            <div class="form-group" style="background-color: rgba(240,244,243,1);">
              <label for="inputEmail" class="col-lg-4 control-label">The task was easy</label>
              <div class="col-lg-1">
                <div class="radio">
                  <input class="inputClass" type="radio" name="easy" value="0" style="margin: 0px;">
                </div>
              </div>
              <div class="col-lg-1">
                <div class="radio">
                  <input class="inputClass" type="radio" name="easy" value="1"style="margin: 0px;">
                </div>
              </div>
              <div class="col-lg-1">
                <div class="radio">
                  <input class="inputClass" type="radio" name="easy" value="2" checked="" style="margin: 0px;">
                </div>
              </div>
              <div class="col-lg-1">
                <div class="radio">
                  <input class="inputClass" type="radio" name="easy" value="3" style="margin: 0px;">
                </div>
              </div>
              <div class="col-lg-1">
                <div class="radio">
                  <input class="inputClass" type="radio" name="easy" value="4" style="margin: 0px;">
                </div>
              </div>
            </div>
            <div class="form-group">
              <label for="inputEmail" class="col-lg-4 control-label"> I was able to complete the task quickly</label>
              <div class="col-lg-1">
                <div class="radio">
                  <input class="inputClass" type="radio" name="quickly" value="0"style="margin: 0px;">
                </div>
              </div>
              <div class="col-lg-1">
                <div class="radio">
                  <input class="inputClass" type="radio" name="quickly" value="1" style="margin: 0px;">
                </div>
              </div>
              <div class="col-lg-1">
                <div class="radio">
                  <input class="inputClass" type="radio" name="quickly" value="2" checked="" style="margin: 0px;">
                </div>
              </div>
              <div class="col-lg-1">
                <div class="radio">
                  <input class="inputClass" type="radio" name="quickly" value="3"style="margin: 0px;">
                </div>
              </div>
              <div class="col-lg-1">
                <div class="radio">
                  <input class="inputClass" type="radio" name="quickly" value="4" style="margin: 0px;">
                </div>
              </div>
            </div>
            <div class="form-group" style="background-color: rgba(240,244,243,1);">
              <label for="inputEmail" class="col-lg-4 control-label">I felt comfortable making the task</label>
              <div class="col-lg-1">
                <div class="radio">
                  <input class="inputClass" type="radio" name="comfortable" value="0" style="margin: 0px;">
                </div>
              </div>
              <div class="col-lg-1">
                <div class="radio">
                  <input class="inputClass" type="radio" name="comfortable" value="1" style="margin: 0px;">
                </div>
              </div>
              <div class="col-lg-1">
                <div class="radio">
                  <input class="inputClass" type="radio" name="comfortable" value="2" checked="" style="margin: 0px;">
                </div>
              </div>
              <div class="col-lg-1">
                <div class="radio">
                  <input class="inputClass" type="radio" name="comfortable" value="3" style="margin: 0px;">
                </div>
              </div>
              <div class="col-lg-1">
                <div class="radio">
                  <input class="inputClass" type="radio" name="comfortable" value="4" style="margin: 0px;">
                </div>
              </div>
            </div>
            <div class="form-group">
              <label for="textArea" class="col-lg-2 control-label">What did you find to be difficult about this task?</label>
              <div class="col-lg-10">
                <textarea class="form-control" rows="3" id="difficult" name="whatDifficult"></textarea>
                <span class="help-block">(optional)</span>
              </div>
            </div>
            <div class="form-group">
              <label for="textArea" class="col-lg-2 control-label">What did you like about this task?</label>
              <div class="col-lg-10">
                <textarea class="form-control" rows="3" id="textArea" name="whatLike"></textarea>
                <span class="help-block">(optional)</span>
              </div>
            </div>
            <div class="form-group">
              <label for="textArea" class="col-lg-2 control-label">What didn't you like about the task?</label>
              <div class="col-lg-10">
                <textarea class="form-control" rows="3" id="textArea" name="whatDislike"></textarea>
                <span class="help-block">(optional)</span>
              </div>
            </div>
            <input value="<%= nextImage %>" id="nextImage" name="nextImage" id="hidden1" hidden>
            <input value="0" id="mapRotation1" name="mapRotation" hidden>
            <input value="0" id="demoClicked1" name="demoClicked" hidden>
            <input value="y" id="objectCoords1" name="objectCoords" style="width:15" hidden>
            <input value="y" id="objectCoordsMap1" name="objectCoordsMap" style="width:15" hidden>
            <input value="y" id="imageSize1" name="imageSize" style="width:15" hidden>
            <input value="y" id="markedObjectId1" name="markedObjectId" hidden>
            <input value="x" id="lat1" name="lat" hidden>
            <input value="x" id="lon1" name="lon" hidden>
            <input value="<%= test %>" id="test" name="test" hidden>
            <input value="" id="knownModal" name="known" hidden>
            <input value="0" id="cID1" name="time" hidden>
            <!--input type="radio" name="knownYes" value="Yes" id="yesModal" onchange="setKnown();" hidden>
            <input type="radio" name="knownNo" value="No" id="noModal" onchange="setKnown();" hidden-->
            <div class="form-group">
              <div class="col-lg-2 col-lg-offset-10">
                <button type="submit" class="btn btn-primary">Submit</button>
              </div>
            </div>
          
          </fieldset>
        </form>
            </div>
            <!--div class="modal-footer">
              <button type="button" class="btn btn-default" data-dismiss="modal">Got it</button>
            </div-->
          </div>
          
        </div>
      </div>

  <!-- Navigation bar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <a class="navbar-brand" href="/">Task <%= test %></a> 
          <a class="navbar-brand" id="cID" hidden></a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li class="active">
                           
              <button onclick="submitObject(<%= properties %>)" hidden>Submit object</button>
            </li>
            <li>
            <form id="getObjects" action='/overpass' method='post' enctype="multipart/form-data" style="white-space: nowrap;">
              <input value="x" id="polyCoords" name="polyCoords" style="width:15" hidden>
              <button type="submit" style="white-space: nowrap;" hidden>Get Objects</button>
              </form>
              </li>
              <li>
              <button onclick="markObject()" style="white-space: nowrap;" hidden>Mark object</button>
              </li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <!-- Image and instractions -->
    <div class="container-fluid">
      <div class="row">
        <div class="col-lg-6">
          <img id="myImg" class="img-thumbnail" src=<%= imageSource %> alt="your image"/>
          <div style="padding-right: 10px; padding-left: 10px;">
          <h3 style="color: red; margin: 5px;" id="heading1" hidden>Instruction&nbsp;<%= test %>: </h3>
          <% if (test=="1") { %>
           <div class="well" id="instructionWell" hidden>You can see a photo and a map. An icon on the map marks the place where the photo has been taken. Please try to define the direction the camera was pointing at when the photo was taken.<br>Use <b>Shift + Left Mouse Key</b> to rotate the map so that the icon points at the right direction.<br> You can switch between satellite view and map view and zoom in and out as you like. 
           <a target="_blank" href="/demo/<%= test %>" id="link" onclick="demo()">Watch demo video</a>
          </div>
            <% } else if (test=="2"){ %>
                 <div class="well" id="instructionWell" hidden>The icon on the map marks the place where the photo has been taken. All buildings within the 200-m radius are highlighted. Please do the following:<br>1. Click one building <b>on the map</b> to select it. It must be a building that you can see in the photo.<br>2. After you have selected a building on the map, a bounding box appears on the image. Move and resize the bounding box to mark the selected building <b>on the photo</b>. If the bounding box disappears, you can draw it again.<br>You can switch between satellite view and map view and zoom in and out as you like.
                 <a target="_blank" href="/demo/<%= test %>" id="link" onclick="demo()">Watch demo video</a>
          </div>
            <% } %>
          
          <button onclick="showPolygon(<%= properties %>)" id="polygon" type="button" hidden>Show polygon</button>
          <form class="form-horizontal" method="post" action="/survey/next/<%= entryId %>" enctype="multipart/form-data" id="nextForm">
          <fieldset>
          <input value="<%= nextImage %>" id="nextImage" name="nextImage" id="hidden1" hidden>
          <input value="0" id="mapRotation2" name="mapRotation" hidden>
          <input value="0" id="demoClicked2" name="demoClicked" hidden>
          <input value="x" id="lat2" name="lat" hidden>
          <input value="x" id="lon2" name="lon" hidden>
          <input value="<%= test %>" id="test" name="test" hidden>
          <input value="y" id="objectCoords2" name="objectCoords" style="width:15" hidden>
          <input value="y" id="objectCoordsMap2" name="objectCoordsMap" style="width:15" hidden>
          <input value="y" id="imageSize2" name="imageSize" style="width:15" hidden>
          <input value="y" id="markedObjectId2" name="markedObjectId" hidden>
          <input value="0" id="cID2" name="time" hidden>
          <% if (modal) { %>
              <button id="next" type="button" class="btn btn-danger" onclick="submitImageAndModal(<%= properties %>)" style="visibility: hidden;" >Next image</button>
          <% } else { %>
             <button id="next" type="button" class="btn btn-danger" onclick="submitImage(<%= properties %>)" style="visibility: hidden;" >Next image</button>
          <% }%>
          <div id="knownDiv">
              <label class="col-lg-4 control-label" style="text-align: left;">Do you know the place shown in the photo?</label>
              <div class="col-lg-8">
                <div class="radio">
                  <label>
                    <input type="radio" name="known" id="known1" value="1" style="text-align: left;">
                    Yes, I know where it is and I could easily find this place on a map.
                  </label>
                </div>
                <div class="radio">
                  <label>
                    <input type="radio" name="known" id="known2" value="2" style="text-align: left;">
                    I've seen this place and I probably could find it on a map. 
                  </label>
                </div>
                <div class="radio">
                  <label>
                    <input type="radio" name="known" id="known3" value="3" style="text-align: left;">
                    This place looks familiar to me, but I'm not sure if I can find it on a map.
                  </label>
                </div>
                <div class="radio">
                  <label>
                    <input type="radio" name="known" id="known4" value="4" style="text-align: left;">
                    No, I have no idea where it is. 
                  </label>
                </div>
              </div>
            </div>
          <button id="saveKnown" type="button" class="btn btn-danger" onclick="setKnown();" style="position: relative; left: 90%;" disabled="disabled">Next</button>
          
          </fieldset>
          </form>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="row">
          </div>
          <!-- Map placeholder -->
          <div class="row">
            <div class="col-lg-12">
              <div id="map" disabled></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
    function demo() {
      document.getElementById("demoClicked1").value = "ja"
      document.getElementById("demoClicked2").value = "ja"
    }
    countdown(1800,'cID')

    jQuery( "#known1" ).change(function() {
      document.getElementById('knownModal').value = "1"
      jQuery('#saveKnown').removeAttr('disabled');
      jQuery('#saveKnown').prop('disabled', false);
    });
    jQuery( "#known2" ).change(function() {
      document.getElementById('knownModal').value = "2"
      jQuery('#saveKnown').removeAttr('disabled');
      jQuery('#saveKnown').prop('disabled', false);
    });
    //G
    jQuery( "#known3" ).change(function() {
      document.getElementById('knownModal').value = "3"
      jQuery('#saveKnown').removeAttr('disabled');
      jQuery('#saveKnown').prop('disabled', false);
    });
    //G
    jQuery( "#known4" ).change(function() {
      document.getElementById('knownModal').value = "4"
      jQuery('#saveKnown').removeAttr('disabled');
      jQuery('#saveKnown').prop('disabled', false);
    });
    //G
    //Global variables
      var buildingsSeen = false
      var marker = false
      var arrow = false
      var vectorLayer
      var vectorLayer2
      var vectorLayer3
      var vectorLayer4
      var vectorLayer5

      var vectorSource2 
      var vectorSource3
      
      var modalCameraRotation = true
      var currentIcon = ""

      jQuery('#map').fadeTo(500,0.01);

      function showBuildings(buildings2, properties, icon, rotation) {
        jQuery('#next').attr('disabled', true)
        buildingsSeen = true
        var features = []

        var buildings = JSON.parse(buildings2)
        console.log("Show buildings: " + buildings)
        
         for (x in buildings) {
                  console.log("type: " + typeof(buildings[x].geometry[0][0]))
                 if (typeof(buildings[x].geometry[0][0])!="number" && typeof(buildings[x].geometry[0][0])!="undefined") {
                  var feature = new ol.Feature({
                    name: buildings[x].id,
                    geometry: new ol.geom.Polygon(buildings[x].geometry)
                  });
                  features.push(feature) 
                 }                
                }

        var splitProp = properties.split(",")
        var lat = Number(splitProp[0].slice(1, splitProp[0].length+1))
        var lon = Number(splitProp[1].slice(0, splitProp[0].length))

        var vectorSource4 = new ol.source.Vector({
                features: features
        });
        var myStyle = new ol.style.Style({
          stroke: new ol.style.Stroke({
            color: 'orange',
            width: 3
          }),
          fill: new ol.style.Fill({
            color: 'rgba(255, 153, 0, 0.5)'
          })
        })
        vectorLayer4 = new ol.layer.Vector({
                source: vectorSource4,
                style: myStyle
        });
  
        var newView2 = new ol.View({
            center: ol.proj.transform([ lon, lat ], 'EPSG:4326', 'EPSG:3857'),
            zoom: 17,
            rotation: Number(rotation)
          })

        map.addLayer(vectorLayer4)
        map.setView(newView2)
        map.render()  
        markObjects()    
        showMarker(JSON.stringify(properties), arrow, rotation)
        
      }
      function setKnown(){
          jQuery('#map').fadeTo(500,1);
          document.getElementById("heading1").hidden = false;
          document.getElementById("instructionWell").hidden = false;
          jQuery("#next").css("visibility", "visible")
          jQuery("#knownDiv").css("visibility", "hidden")
          jQuery("#saveKnown").css("visibility", "hidden")

      }
      function activateSubmit() {

      }
      function markObjects() {
        var mySelectInteraction = new ol.interaction.Select()
        mySelectInteraction.getFeatures().on('add', function(e) {
          if (e.target.getArray().length==1) {
            jQuery('#next').prop('disabled', false);
            jQuery('#next').removeAttr('disabled');
            markObject(); 
          } else {
            jQuery.noConflict();
            jQuery('#myImg').imgAreaSelect({remove:true});
            jQuery('#next').attr('disabled', true)
          }
          var feature = e.element // Do something with the feature
          var coordinates = feature.getGeometry().getCoordinates()
        });

        mySelectInteraction.getFeatures().on('remove', function(e) {
          if (e.target.getArray().length==1) {
            jQuery('#next').prop('disabled', false);
            jQuery('#next').removeAttr('disabled');
            
            markObject(); 
            
          } if (e.target.getArray().length==0) {
            jQuery.noConflict();
            if (modalCameraRotation) {
              jQuery('#next').prop('disabled', true);
            } 
            jQuery('#myImg').imgAreaSelect({remove:true}); 
          } else {
            jQuery('#next').attr('disabled', true)
          }
          var feature = e.element // Do something with the feature
          var coordinates = feature.getGeometry().getCoordinates()
         // console.log("Feature: " + e.target.getArray().length)         
        });
        map.addInteraction(mySelectInteraction) 
      }

      /* display uploaded image */
      function preview(img, selection) {
        var width = img.width
        var xy = selection.x1 + " " + selection.y1 + " " + selection.x2 + " " + selection.y2
        console.log(xy)
        document.getElementById("objectCoords1").value = xy;
        document.getElementById("imageSize1").value = width;  
        document.getElementById("objectCoords2").value = xy;
        document.getElementById("imageSize2").value = width; 
      }

      // mark an object on image using bounding box
      function markObject() {
          document.getElementById("objectCoords1").value = "253 120 413 250"
          document.getElementById("objectCoords2").value = "253 120 413 250"
          jQuery.noConflict();

           jQuery('#next').prop('disabled', false);
            //jQuery('#next').removeAttr('disabled');
          jQuery('#myImg').imgAreaSelect({
              x1: 253, y1: 120, x2: 413, y2: 250, 
              handles: true,
              onSelectEnd: preview
          });
      }

      /* OpenLayers 3 */
      //create satellite layer
      var sourceBingMaps = new ol.source.BingMaps({
            key: 'Ag4eQzHgpn-LvpD_4Mx6Vsx7TslsxykxKc_cGyf2HDZtQqmg5oZEeX4mmwVOGtyz',
            imagerySet: 'Aerial',
          });

      // create an interactions and controls
      var mouseZoom = new ol.interaction.MouseWheelZoom();
      var pinch = new ol.interaction.PinchRotate()
      var interaction = new ol.interaction.DragRotate({ condition: ol.events.condition.shiftKeyOnly });
      var pan = new ol.interaction.DragPan();
      var rotateControl = new ol.control.Rotate();
      var zoomControl = new ol.control.Zoom();
      var layerSwitcher = new ol.control.LayerSwitcher();

      var myView = new ol.View({
        center: ol.proj.transform([ 7.617449, 51.963416  ], 'EPSG:4326', 'EPSG:3857'),
        zoom: 15
      })
      var map = new ol.Map({
        target: 'map',
        controls: [rotateControl, zoomControl, layerSwitcher],
        layers: [
          new ol.layer.Tile({
            title: 'OSM',
            type: 'base',
            visible: true,
            source: new ol.source.OSM()
          }),
          new ol.layer.Tile({
            title: 'Satellite',
            type: 'base',
            visible: false,
            source: sourceBingMaps
          })
        ],
        view: myView,
        interactions: [interaction, mouseZoom, pan, pinch ]
      });

      /* convert radians to degrees 
            * @param rad: angle in radians
            * @return angle in degrees
      */
      function radToDegree(rad) {
        var degrees = Math.abs(rad)*(180/Math.PI)
        if (degrees > 360) { 
          degrees = degrees - (Math.floor(degrees / 360)*360) 
        } 
        if (rad<0) {
          degrees = 360 - degrees
        }
        return degrees
      }

      /* show the triangle polygon
        * @param coordsString: coordinates of the polygon nodes (left and right to the focus point)
        * @param lat: Latitude cooridnate of the origin (camera location)
        * @param lon: Longitude coordinate of the origin (camera location)
        * @param targetLat: Latitude coordinate of the focus point
        * @param targetLon: Longitude coordinate of the focus point
      */
      function findTriangle(coordsString, lat, lon, targetLat, targetLon)  {

        var imageCoords = [ Number(lon), Number(lat) ]
        var target = [ Number(targetLon), Number(targetLat) ]

        var split = coordsString.split(" ")
        left = [ parseFloat(split[1]), parseFloat(split[0]) ]
        right = [ parseFloat(split[3]), parseFloat(split[2]) ]
        var point1 = ol.proj.transform(imageCoords, 'EPSG:4326', 'EPSG:3857');
        var point2 = ol.proj.transform(left, 'EPSG:4326', 'EPSG:3857');
        var point3 = ol.proj.transform(right, 'EPSG:4326', 'EPSG:3857');
        var point4 = ol.proj.transform(imageCoords, 'EPSG:4326', 'EPSG:3857');
        var point6 = ol.proj.transform(target, 'EPSG:4326', 'EPSG:3857');
        var feature = new ol.Feature({
          geometry: new ol.geom.Polygon([[point1, point2, point3, point4]]),
        });

        var coords = coordsString + " " + lat + " " + lon
        document.getElementById('polyCoords').value = coords
        vectorSource2 = new ol.source.Vector({
                features: [feature ]
        });
        vectorLayer2 = new ol.layer.Vector({
                source: vectorSource2,
        });
        map.addLayer(vectorLayer2)
        /*draw line */
        var featureL = new ol.Feature({
                    geometry: new ol.geom.LineString([point6, point1])
        });
        vectorSource3 = new ol.source.Vector({
                features: [featureL ]
        });
        vectorLayer3 = new ol.layer.Vector({
          source: vectorSource3
        });
        map.addLayer(vectorLayer3) 
      }
          
      /* send request to the server to get polygon coordinates */
      function showPolygon(properties) {
        jQuery.get("/showPolygon", { 
          mapRotation : map.getView().getRotation(),
          lat: properties[0],
          lon: properties[1]
        }, function(response){
          findTriangle(response.coords, response.lat, response.lon, response.targetLat, response.targetLon)          
        });
      }
      function defineCenter(bb) {
  /*
        var p1 = ol.proj.transform([ Number(bb[1]), Number(bb[0])], 'EPSG:3857', 'EPSG:4326')
        var p2 = ol.proj.transform([ Number(bb[3]), Number(bb[2])], 'EPSG:3857', 'EPSG:4326')    */

        var x = (Number(bb[0])+Number(bb[2]))/2
        var y = (Number(bb[1])+Number(bb[3]))/2 
        //var temp = ol.proj.transform([x, y], 'EPSG:3857', 'EPSG:4326')

        var center = [ { x: x, y: y } ]
        center = JSON.stringify(center)
        return center
      }
      /* save current map rotation and proceed to the next image */
      function submitImage(properties) {
        document.getElementById('cID1').value = jQuery('#cID').text()
        document.getElementById('cID2').value = jQuery('#cID').text()

        if (map.getInteractions().getArray().length>4) {
          var select = map.getInteractions().getArray()[4] 
          console.log("Select: " + select.getKeys() + " " + select.length + " " + select[0])
          var features = select.getFeatures();
          var feature = features.item(0);
          document.getElementById("objectCoordsMap1").value = defineCenter(feature.getGeometry().getExtent())
          document.getElementById("objectCoordsMap2").value = defineCenter(feature.getGeometry().getExtent())
          document.getElementById("markedObjectId1").value = feature.getProperties().name
          document.getElementById("markedObjectId2").value = feature.getProperties().name
          var selectedBuildings = [{ 
                id:  feature.getProperties().name,
                geometry: feature.getGeometry().getCoordinates() 
          }]
        }
        var origin = new ol.geom.Point(ol.proj.transform([ properties[1], properties[0] ], 'EPSG:4326', 'EPSG:3857'))
        console.log("Origin: " + JSON.stringify(origin.getCoordinates()) + " " + origin.getCoordinates()[0])
        document.getElementById("mapRotation1").value = map.getView().getRotation()
        document.getElementById("mapRotation2").value = map.getView().getRotation()
        document.getElementById("lat1").value = origin.getCoordinates()[0]
        document.getElementById("lon1").value = origin.getCoordinates()[1]
        document.getElementById("lat2").value = origin.getCoordinates()[0]
        document.getElementById("lon2").value = origin.getCoordinates()[1]

        
        
        jQuery( "#nextForm" ).submit();
      }

      function submitModalForm(properties) {
        console.log("submitModalForm")
        document.getElementById("inputName2").value = document.getElementById("inputName1").value
        document.getElementById("computerSkills2").value = document.getElementById("computerSkills1").value
        console.log(document.getElementById("inputName1").value + " " + document.getElementById("computerSkills1").value)
        document.getElementById("mapRotation1").value = map.getView().getRotation()
        document.getElementById("mapRotation2").value = map.getView().getRotation()
         var origin = new ol.geom.Point(ol.proj.transform([ properties[1], properties[0] ], 'EPSG:4326', 'EPSG:3857'))
        document.getElementById("lat1").value = origin.getCoordinates()[0]
        document.getElementById("lon1").value = origin.getCoordinates()[1]
        document.getElementById("lat2").value = origin.getCoordinates()[0]
        document.getElementById("lon2").value = origin.getCoordinates()[1]
        //jQuery( "#nextForm" ).submit();
      }

      function submitImageAndModal(properties) {
        document.getElementById('cID1').value = jQuery('#cID').text()
        document.getElementById('cID2').value = jQuery('#cID').text()

        if (map.getInteractions().getArray().length>4) {
          var select = map.getInteractions().getArray()[4] 
          console.log("Select: " + select.getKeys() + " " + select.length + " " + select[0])
          var features = select.getFeatures();
          var feature = features.item(0);
          document.getElementById("objectCoordsMap1").value = defineCenter(feature.getGeometry().getExtent())
          document.getElementById("objectCoordsMap2").value = defineCenter(feature.getGeometry().getExtent())
          document.getElementById("markedObjectId1").value = feature.getProperties().name
          document.getElementById("markedObjectId2").value = feature.getProperties().name
          var selectedBuildings = [{ 
                id:  feature.getProperties().name,
                geometry: feature.getGeometry().getCoordinates() 
          }]
        }

        document.getElementById("mapRotation1").value = map.getView().getRotation()
        document.getElementById("mapRotation2").value = map.getView().getRotation()
        var origin = new ol.geom.Point(ol.proj.transform([ properties[1], properties[0] ], 'EPSG:4326', 'EPSG:3857'))
        document.getElementById("lat1").value = origin.getCoordinates()[0]
        document.getElementById("lon1").value = origin.getCoordinates()[1]
        document.getElementById("lat2").value = origin.getCoordinates()[0]
        document.getElementById("lon2").value = origin.getCoordinates()[1]

        console.log("submitImageAndModal")
        jQuery.noConflict();
        jQuery("#modal").modal("show");
        /*document.getElementById("mapRotation").value = map.getView().getRotation()
        document.getElementById("lat").value = properties[0]
        document.getElementById("lon").value = properties[1]
        jQuery( "#nextForm" ).submit(); */
      }

      function submitObject(properties) {
        jQuery.get("/triangle", { 
          mapRotation : undefined,
          lat: properties[0],
          lon: properties[1],
          objectCoords: document.getElementById("objectCoords").value,
          imageSize: document.getElementById("imageSize").value,
          objectCoordsMap: document.getElementById("objectCoordsMap").value
        }, function(response){
          findTriangle(response.coords, response.lat, response.lon, response.targetLat, response.targetLon)          
        });
      }

      //add marker
      function showMarker(properties1, icon, rotation) { 
        console.log("Show Marker with  " + icon)
            currentIcon  = icon
            if (icon=="arrow") {
              modalCameraRotation = false
            }
           
          if (typeof(properties1)=="string") {
            var splitProp = properties1.split(",")
            var lat = Number(splitProp[0].slice(2, splitProp[0].length))
            var lon = Number(splitProp[1].slice(0, splitProp[0].length-1))
            var properties = [lat,lon]
          } else {
            var properties = properties1
          }
          
          if (icon=="arrow" && vectorLayer!=undefined) {
            
            marker = true
            arrow = true
            var source = "https://i.imgur.com/gz61vEY.png"
            var iconStyle = new ol.style.Style({
              image: new ol.style.Icon(/** @type {olx.style.IconOptions} */ ({
                anchor: [ 0.5, 400],
                scale: 0.2,
                anchorXUnits: 'fraction',
                anchorYUnits: 'pixels',
                src: source
              }))
            });
            vectorLayer.setStyle(iconStyle)
            console.log("1")
            //map.render()
          } else if (icon=="arrow") {
            console.log("2")
            marker = true
            arrow = true
            var source = "https://i.imgur.com/gz61vEY.png"
            marker = true 
          if (properties) {
            var lat = properties[0]
            var lon = properties[1]
            var iconFeatures=[];
            var iconFeature = new ol.Feature({
              geometry: new ol.geom.Point(ol.proj.transform([ lon, lat ], 'EPSG:4326', 'EPSG:3857')),

            });
            var testpoint = new ol.geom.Point(ol.proj.transform([ lon, lat ], 'EPSG:4326', 'EPSG:3857'))
            iconFeatures.push(iconFeature);
            var vectorSource = new ol.source.Vector({
              features: iconFeatures 
            });
            var iconStyle = new ol.style.Style({
              image: new ol.style.Icon(/** @type {olx.style.IconOptions} */ ({
                anchor: [ 0.5, 400],
                scale: 0.2,
                anchorXUnits: 'fraction',
                anchorYUnits: 'pixels',
                src: source
              }))
            });
            vectorLayer = new ol.layer.Vector({
              source: vectorSource,
              style: iconStyle
            });
            var newView = new ol.View({
                  center: ol.proj.transform([ lon, lat ], 'EPSG:4326', 'EPSG:3857'),
                  zoom: 17,
                  rotation: Number(rotation)
            })
            map.addLayer(vectorLayer)
            map.setView(newView)
          }
          } 
            else {
              console.log("3")
            var source = "http://i1230.photobucket.com/albums/ee488/PerfectlyDarkTails/Map-Marker-Flag-2-Right-Red-icon_zps4cea0902.png"
            marker = true 
          if (properties) {
            var lat = properties[0]
            var lon = properties[1]
            var iconFeatures=[];
            var iconFeature = new ol.Feature({
              geometry: new ol.geom.Point(ol.proj.transform([ lon, lat ], 'EPSG:4326', 'EPSG:3857')),
              name: 'Muenster'
            });
            iconFeatures.push(iconFeature);
            var vectorSource = new ol.source.Vector({
              features: iconFeatures 
            });
            var iconStyle = new ol.style.Style({
              image: new ol.style.Icon(/** @type {olx.style.IconOptions} */ ({
                anchor: [ 0.5, 200],
                scale: 0.2,
                anchorXUnits: 'fraction',
                anchorYUnits: 'pixels',
                src: source
              }))
            });
            vectorLayer = new ol.layer.Vector({
              source: vectorSource,
              style: iconStyle
            });
            var newView = new ol.View({
                  center: ol.proj.transform([ lon, lat ], 'EPSG:4326', 'EPSG:3857'),
                  zoom: 17,
                  rotation: Number(rotation)
            })
            var testpoint = new ol.geom.Point(ol.proj.transform([ lon, lat ], 'EPSG:4326', 'EPSG:3857'))
            map.addLayer(vectorLayer)
            map.setView(newView)
          }
          }   
      }
      /*
    Author: Benjamin Eckstein
    http://www.umingo.de/
     
    You can use this code in any manner so long as the author's
    name, Web address and this disclaimer is kept intact.
    ********************************************************
    */

    function countdown(time,id) {
      //time brauchen wir später noch
      t = time;
     
      //Tage berechnen
      d = Math.floor(t/(60*60*24)) % 24; 
     
      // Stunden berechnen
      h = Math.floor(t/(60*60)) % 24;
     
     
      // Minuten berechnen
      // Sekunden durch 60 ergibt Minuten
      // Minuten gehen von 0-59
      //also Modulo 60 rechnen
      m = Math.floor(t/60) %60;
     
      // Sekunden berechnen
      s = t %60;
     
      //Zeiten formatieren
      d = (d >  0) ? d+"d ":"";
      h = (h < 10) ? "0"+h : h;
      m = (m < 10) ? "0"+m : m;
      s = (s < 10) ? "0"+s : s;
     
      // Ausgabestring generieren
      strZeit =d + h + ":" + m + ":" + s;

      // Falls der Countdown noch nicht zurückgezählt ist
      if(time > 0)
      {
        //Countdown-Funktion erneut aufrufen
        //diesmal mit einer Sekunde weniger
        window.setTimeout('countdown('+ --time+',\''+id+'\')',1000);
      }
      else
      {
        //führe eine funktion aus oder refresh die seite
        //dieser Teil hier wird genau einmal ausgeführt und zwar 
        //wenn die Zeit um ist.
       
      }
      // Ausgabestring in Tag mit id="id" schreiben
      document.getElementById(id).innerHTML = strZeit;
    }

    </script>
  </body>
</html>